<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
    <TITLE>Completion and Finalization</TITLE>
    <META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <META NAME="Author" CONTENT="JTC1/SC22/WG9/ARG, by Randall Brukardt, ARG Editor">
    <META NAME="GENERATOR" CONTENT="Arm_Form.Exe, Ada Reference Manual generator">
    <STYLE type="text/css">
    H4.centered {text-align: center}
    SPAN.swiss {font-family: Arial, Helvetica, sans-serif; font-size: 92%}
    SPAN.roman {font-family: "Times New Roman", Times, serif}
    DIV.paranum {float: left; font-family: Arial, Helvetica, sans-serif; font-size: 64%; width: 2.8em; margin-left: -0.4em; margin-right: -3.0em; margin-top: 0.2em}
    TT {font-family: "Courier New", monospace}
    DT {display: compact}
    DIV.Normal {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 1.2em; margin-bottom: 0.6em}
    DIV.Notes {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 3.7em; margin-bottom: 0.6em}
    DIV.NotesHeader {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 3.7em}
    UL.Bulleted {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.2em; margin-right: 2.0em; margin-top: 0em; margin-bottom: 0.5em}
    </STYLE>
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFF0" LINK="#000080" VLINK="#330033" ALINK="#0000FF">
<DIV><SPAN Style="font-size:200%; color: rgb(0,0,153)"><B>Ada Reference Manual</B></SPAN> &mdash; <A HREF="RM-TTL.html"><B>Legal Information</B></A></DIV>
<DIV Style="margin-top: 0.6em; margin-bottom: 0.0em"><A HREF="RM-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-0-5.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-7-6.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-8.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</DIV>
<HR>
<H1>7.6.1 Completion and Finalization</H1>
<DIV Class="paranum">1</DIV>
<DIV Class="Normal">This subclause defines <I>completion</I> and <I>leaving</I> 
of the execution of constructs and entities. A <I>master</I> is the execution 
of a construct that includes finalization of local objects after it is 
complete (and after waiting for any local tasks &mdash; see <A HREF="RM-9-3.html">9.3</A>), 
but before leaving. Other constructs and entities are left immediately 
upon completion. <A NAME="I3316"></A><A NAME="I3317"></A></DIV>

<H4 Class="centered">Dynamic Semantics</H4>
<DIV Class="paranum">2/2</DIV>
<DIV Class="Normal"><A NAME="I3318"></A><A NAME="I3319"></A>The execution 
of a construct or entity is <I>complete</I> when the end of that execution 
has been reached, or when a transfer of control (see <A HREF="RM-5-1.html">5.1</A>) 
causes it to be abandoned. <A NAME="I3320"></A><A NAME="I3321"></A><A NAME="I3322"></A><A NAME="I3323"></A>Completion 
due to reaching the end of execution, or due to the transfer of control 
of an <SPAN Class="swiss"><A HREF="RM-5-7.html#S0146">exit_statement</A></SPAN>, 
return statement, <SPAN Class="swiss"><A HREF="RM-5-8.html#S0147">goto_statement</A></SPAN>, 
or <SPAN Class="swiss"><A HREF="RM-9-5-4.html#S0208">requeue_statement</A></SPAN> 
or of the selection of a <SPAN Class="swiss"><A HREF="RM-9-7-1.html#S0218">terminate_alternative</A></SPAN> 
is <I>normal completion</I>. Completion is <I>abnormal</I> otherwise 
&mdash; when control is transferred out of a construct due to abort or 
the raising of an exception.&nbsp;</DIV>
<DIV Class="paranum">3/2</DIV>
<DIV Class="Normal"><A NAME="I3324"></A><A NAME="I3325"></A>After execution 
of a construct or entity is complete, it is <I>left</I>, meaning that 
execution continues with the next action, as defined for the execution 
that is taking place. <A NAME="I3326"></A>Leaving an execution happens 
immediately after its completion, except in the case of a <I>master</I>: 
the execution of a body other than a <SPAN Class="swiss"><A HREF="RM-7-2.html#S0175">package_body</A></SPAN>; 
the execution of a <SPAN Class="swiss"><A HREF="RM-5-1.html#S0131">statement</A></SPAN>; 
or the evaluation of an <SPAN Class="swiss"><A HREF="RM-4-4.html#S0115">expression</A></SPAN>, 
<SPAN Class="swiss"><A HREF="RM-6-4.html#S0164">function_call</A></SPAN>, 
or <SPAN Class="swiss"><A HREF="RM-3-5.html#S0037">range</A></SPAN> that 
is not part of an enclosing <SPAN Class="swiss"><A HREF="RM-4-4.html#S0115">expression</A></SPAN>, 
<SPAN Class="swiss"><A HREF="RM-6-4.html#S0164">function_call</A></SPAN>, 
<SPAN Class="swiss"><A HREF="RM-3-5.html#S0037">range</A></SPAN>, or 
<SPAN Class="swiss"><A HREF="RM-5-1.html#S0132">simple_statement</A></SPAN> 
other than a <SPAN Class="swiss"><A HREF="RM-6-5.html#S0168">simple_return_statement</A></SPAN>. 
A master is finalized after it is complete, and before it is left.</DIV>
<DIV Class="paranum">4</DIV>
<DIV Class="Normal"><A NAME="I3327"></A>For the <I>finalization</I> of 
a master, dependent tasks are first awaited, as explained in <A HREF="RM-9-3.html">9.3</A>. 
Then each object whose accessibility level is the same as that of the 
master is finalized if the object was successfully initialized and still 
exists. These actions are performed whether the master is left by reaching 
the last statement or via a transfer of control. When a transfer of control 
causes completion of an execution, each included master is finalized 
in order, from innermost outward.&nbsp;</DIV>
<DIV Class="paranum">5</DIV>
<DIV Class="Normal" Style="margin-bottom: 0.4em"><A NAME="I3328"></A>For 
the <I>finalization</I> of an object:&nbsp;</DIV>
<DIV Class="paranum">6</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>If the object is of an elementary 
type, finalization has no effect;</LI></UL>
<DIV Class="paranum">7</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>If the object is of a controlled type, 
the Finalize procedure is called;</LI></UL>
<DIV Class="paranum">8</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>If the object is of a protected type, 
the actions defined in <A HREF="RM-9-4.html">9.4</A> are performed;</LI></UL>
<DIV Class="paranum">9/2</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>If the object is of a composite type, 
then after performing the above actions, if any, every component of the 
object is finalized in an arbitrary order, except as follows: if the 
object has a component with an access discriminant constrained by a per-object 
expression, this component is finalized before any components that do 
not have such discriminants; for an object with several components with 
such a discriminant, they are finalized in the reverse of the order of 
their <SPAN Class="swiss"><A HREF="RM-3-8.html#S0070">component_declaration</A></SPAN>s; 
</LI></UL>
<DIV Class="paranum">9.1/2</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>If the object has coextensions (see 
<A HREF="RM-3-10-2.html">3.10.2</A>), each coextension is finalized after 
the object whose access discriminant designates it.</LI></UL>
<DIV Class="paranum">10</DIV>
<DIV Class="Normal"><A NAME="I3329"></A>Immediately before an instance 
of Unchecked_Deallocation reclaims the storage of an object, the object 
is finalized. If an instance of Unchecked_Deallocation is never applied 
to an object created by an <SPAN Class="swiss"><A HREF="RM-4-8.html#S0129">allocator</A></SPAN>, 
the object will still exist when the corresponding master completes, 
and it will be finalized then.</DIV>
<DIV Class="paranum">11/2</DIV>
<DIV Class="Normal">&nbsp;The order in which the finalization of a master 
performs finalization of objects is as follows: Objects created by declarations 
in the master are finalized in the reverse order of their creation. For 
objects that were created by <SPAN Class="swiss"><A HREF="RM-4-8.html#S0129">allocator</A></SPAN>s 
for an access type whose ultimate ancestor is declared in the master, 
this rule is applied as though each such object that still exists had 
been created in an arbitrary order at the first freezing point (see <A HREF="RM-13-14.html">13.14</A>) 
of the ultimate ancestor type; the finalization of these objects is called 
the <I>finalization of the collection</I><A NAME="I3330"></A><A NAME="I3331"></A>. 
After the finalization of a master is complete, the objects finalized 
as part of its finalization cease to <I>exist</I>, as do any types and 
subtypes defined and created within the master.<A NAME="I3332"></A> <A NAME="I3333"></A><A NAME="I3334"></A></DIV>
<DIV Class="paranum">12/2</DIV>
<DIV Class="Normal">&nbsp;<A NAME="I3335"></A>The target of an <SPAN Class="swiss"><A HREF="RM-5-2.html#S0137">assignment_statement</A></SPAN> 
is finalized before copying in the new value, as explained in <A HREF="RM-7-6.html">7.6</A>.</DIV>
<DIV Class="paranum">13/2</DIV>
<DIV Class="Normal">&nbsp;The master of an object is the master enclosing 
its creation whose accessibility level (see <A HREF="RM-3-10-2.html">3.10.2</A>) 
is equal to that of the object.&nbsp;</DIV>
<DIV Class="paranum">13.1/2</DIV>
<DIV Class="Normal">&nbsp;&nbsp;&nbsp;In the case of an <SPAN Class="swiss"><A HREF="RM-4-4.html#S0115">expression</A></SPAN> 
that is a master, finalization of any (anonymous) objects occurs as the 
final part of evaluation of the <SPAN Class="swiss"><A HREF="RM-4-4.html#S0115">expression</A></SPAN>.</DIV>

<H4 Class="centered">Bounded (Run-Time) Errors</H4>
<DIV Class="paranum">14/1</DIV>
<DIV Class="Normal" Style="margin-bottom: 0.4em">&nbsp;<A NAME="I3336"></A>It 
is a bounded error for a call on Finalize or Adjust that occurs as part 
of object finalization or assignment to propagate an exception. The possible 
consequences depend on what action invoked the Finalize or Adjust operation: 
</DIV>
<DIV Class="paranum">15</DIV>
<UL Class="Bulleted"><LI TYPE=DISC><A NAME="I3337"></A>For a Finalize 
invoked as part of an <SPAN Class="swiss"><A HREF="RM-5-2.html#S0137">assignment_statement</A></SPAN>, 
Program_Error is raised at that point.</LI></UL>
<DIV Class="paranum">16/2</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>For an Adjust invoked as part of assignment 
operations other than those invoked as part of an <SPAN Class="swiss"><A HREF="RM-5-2.html#S0137">assignment_statement</A></SPAN>, 
other adjustments due to be performed might or might not be performed, 
and then Program_Error is raised. During its propagation, finalization 
might or might not be applied to objects whose Adjust failed. <A NAME="I3338"></A>For 
an Adjust invoked as part of an <SPAN Class="swiss"><A HREF="RM-5-2.html#S0137">assignment_statement</A></SPAN>, 
any other adjustments due to be performed are performed, and then Program_Error 
is raised.&nbsp;</LI></UL>
<DIV Class="paranum">17</DIV>
<UL Class="Bulleted"><LI TYPE=DISC><A NAME="I3339"></A>For a Finalize 
invoked as part of a call on an instance of Unchecked_Deallocation, any 
other finalizations due to be performed are performed, and then Program_Error 
is raised.&nbsp;</LI></UL>
<DIV Class="paranum">17.1/1</DIV>
<UL Class="Bulleted"><LI TYPE=DISC><A NAME="I3340"></A>For a Finalize 
invoked as part of the finalization of the anonymous object created by 
a function call or <SPAN Class="swiss"><A HREF="RM-4-3.html#S0104">aggregate</A></SPAN>, 
any other finalizations due to be performed are performed, and then Program_Error 
is raised.</LI></UL>
<DIV Class="paranum">17.2/1</DIV>
<UL Class="Bulleted"><LI TYPE=DISC><A NAME="I3341"></A>For a Finalize 
invoked due to reaching the end of the execution of a master, any other 
finalizations associated with the master are performed, and Program_Error 
is raised immediately after leaving the master.</LI></UL>
<DIV Class="paranum">18/2</DIV>
<UL Class="Bulleted"><LI TYPE=DISC><A NAME="I3342"></A>For a Finalize 
invoked by the transfer of control of an <SPAN Class="swiss"><A HREF="RM-5-7.html#S0146">exit_statement</A></SPAN>, 
return statement, <SPAN Class="swiss"><A HREF="RM-5-8.html#S0147">goto_statement</A></SPAN>, 
or <SPAN Class="swiss"><A HREF="RM-9-5-4.html#S0208">requeue_statement</A></SPAN>, 
Program_Error is raised no earlier than after the finalization of the 
master being finalized when the exception occurred, and no later than 
the point where normal execution would have continued. Any other finalizations 
due to be performed up to that point are performed before raising Program_Error. 
</LI></UL>
<DIV Class="paranum">19</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>For a Finalize invoked by a transfer 
of control that is due to raising an exception, any other finalizations 
due to be performed for the same master are performed; Program_Error 
is raised immediately after leaving the master.&nbsp;</LI></UL>
<DIV Class="paranum">20</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>For a Finalize invoked by a transfer 
of control due to an abort or selection of a terminate alternative, the 
exception is ignored; any other finalizations due to be performed are 
performed.&nbsp;</LI></UL>
<DIV Class="NotesHeader">NOTES</DIV>
<DIV Class="paranum">21</DIV>
<DIV Class="Notes">17&nbsp;&nbsp;The rules of Section 10 imply that immediately 
prior to partition termination, Finalize operations are applied to library-level 
controlled objects (including those created by <SPAN Class="swiss"><A HREF="RM-4-8.html#S0129">allocator</A></SPAN>s 
of library-level access types, except those already finalized). This 
occurs after waiting for library-level tasks to terminate.&nbsp;</DIV>
<DIV Class="paranum">22</DIV>
<DIV Class="Notes">18&nbsp;&nbsp;A constant is only constant between 
its initialization and finalization. Both initialization and finalization 
are allowed to change the value of a constant.</DIV>
<DIV Class="paranum">23</DIV>
<DIV Class="Notes">19&nbsp;&nbsp;Abort is deferred during certain operations 
related to controlled types, as explained in <A HREF="RM-9-8.html">9.8</A>. 
Those rules prevent an abort from causing a controlled object to be left 
in an ill-defined state.</DIV>
<DIV Class="paranum">24</DIV>
<DIV Class="Notes">20&nbsp;&nbsp;The Finalize procedure is called upon 
finalization of a controlled object, even if Finalize was called earlier, 
either explicitly or as part of an assignment; hence, if a controlled 
type is visibly controlled (implying that its Finalize primitive is directly 
callable), or is nonlimited (implying that assignment is allowed), its 
Finalize procedure should be designed to have no ill effect if it is 
applied a second time to the same object.&nbsp;</DIV>

<HR>
<DIV Style="margin-top: 0.0em; margin-bottom: 0.6em"><A HREF="RM-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-0-5.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-7-6.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-8.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</DIV>
<DIV Style="margin-top:0.0em"><IMG SRC="AE_logo.gif" height=100 width=113 align=right ALT="Ada-Europe">
<SPAN Style="vertical-align: middle">Sponsored by <SPAN Style="font-size: 125%"><A HREF="http://www.ada-europe.org/"><B>Ada-Europe</B></A></SPAN></SPAN></DIV>
</BODY>
</HTML>
