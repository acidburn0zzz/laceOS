<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
    <TITLE>Protected Procedure Handlers</TITLE>
    <META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <META NAME="Author" CONTENT="JTC1/SC22/WG9/ARG, by Randall Brukardt, ARG Editor">
    <META NAME="GENERATOR" CONTENT="Arm_Form.Exe, Ada Reference Manual generator">
    <STYLE type="text/css">
    H4.centered {text-align: center}
    SPAN.swiss {font-family: Arial, Helvetica, sans-serif; font-size: 92%}
    SPAN.roman {font-family: "Times New Roman", Times, serif}
    DIV.paranum {float: left; font-family: Arial, Helvetica, sans-serif; font-size: 64%; width: 2.8em; margin-left: -0.4em; margin-right: -3.0em; margin-top: 0.2em}
    TT {font-family: "Courier New", monospace}
    DT {display: compact}
    DIV.Normal {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 1.2em; margin-bottom: 0.6em}
    DIV.Notes {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 3.7em; margin-bottom: 0.6em}
    DIV.NotesHeader {font-family: "Times New Roman", Times, serif; font-size: 80%; line-height: 122%; margin-left: 3.7em}
    DIV.SyntaxIndented {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.2em; margin-bottom: 0.4em}
    UL.Bulleted {font-family: "Times New Roman", Times, serif; line-height: 122%; margin-left: 3.2em; margin-right: 2.0em; margin-top: 0em; margin-bottom: 0.5em}
    </STYLE>
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFF0" LINK="#000080" VLINK="#330033" ALINK="#0000FF">
<DIV><SPAN Style="font-size:200%; color: rgb(0,0,153)"><B>Ada Reference Manual</B></SPAN> &mdash; <A HREF="RM-TTL.html"><B>Legal Information</B></A></DIV>
<DIV Style="margin-top: 0.6em; margin-bottom: 0.0em"><A HREF="RM-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-0-5.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-C-3.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-C-3-2.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</DIV>
<HR>
<H1>C.3.1 Protected Procedure Handlers</H1>

<H4 Class="centered">Syntax</H4>
<DIV Class="paranum">1</DIV>
<DIV Class="SyntaxIndented" Style="margin-bottom: 0.2em">The form of 
a <SPAN Class="swiss"><A HREF="RM-2-8.html#S0019">pragma</A></SPAN> Interrupt_Handler 
is as follows:&nbsp;</DIV>
<DIV Class="paranum">2</DIV>
<DIV Class="SyntaxIndented">&nbsp;&nbsp;<B>pragma</B> <A NAME="I6677"></A><A NAME="I6678"></A>Interrupt_Handler(<I>handler_</I><A NAME="I6679"></A><SPAN Class="swiss"><A HREF="RM-4-1.html#S0091">name</A></SPAN>);</DIV>
<DIV Class="paranum">3</DIV>
<DIV Class="SyntaxIndented" Style="margin-bottom: 0.2em">The form of 
a <SPAN Class="swiss"><A HREF="RM-2-8.html#S0019">pragma</A></SPAN> Attach_Handler 
is as follows:&nbsp;</DIV>
<DIV Class="paranum">4</DIV>
<DIV Class="SyntaxIndented">&nbsp;&nbsp;<B>pragma</B> <A NAME="I6680"></A><A NAME="I6681"></A>Attach_Handler(<I>handler_</I><A NAME="I6682"></A><SPAN Class="swiss"><A HREF="RM-4-1.html#S0091">name</A></SPAN>, 
<A NAME="I6683"></A><SPAN Class="swiss"><A HREF="RM-4-4.html#S0115">expression</A></SPAN>); 
</DIV>

<H4 Class="centered">Name Resolution Rules</H4>
<DIV Class="paranum">5</DIV>
<DIV Class="Normal">For the Interrupt_Handler and Attach_Handler pragmas, 
the <I>handler_</I><SPAN Class="swiss"><A HREF="RM-4-1.html#S0091">name</A></SPAN> 
shall resolve to denote a protected procedure with a parameterless profile.</DIV>
<DIV Class="paranum">6</DIV>
<DIV Class="Normal">For the Attach_Handler pragma, the expected type 
for the <SPAN Class="swiss"><A HREF="RM-4-4.html#S0115">expression</A></SPAN> 
is Interrupts.Interrupt_ID (see <A HREF="RM-C-3-2.html">C.3.2</A>).&nbsp;</DIV>

<H4 Class="centered">Legality Rules</H4>
<DIV Class="paranum">7/2</DIV>
<DIV Class="Normal">The Attach_Handler pragma is only allowed immediately 
within the <SPAN Class="swiss"><A HREF="RM-9-4.html#S0195">protected_definition</A></SPAN> 
where the corresponding subprogram is declared. The corresponding <SPAN Class="swiss"><A HREF="RM-9-4.html#S0193">protected_type_declaration</A></SPAN> 
or <SPAN Class="swiss"><A HREF="RM-9-4.html#S0194">single_protected_declaration</A></SPAN> 
shall be a library-level declaration.&nbsp;</DIV>
<DIV Class="paranum">8/2</DIV>
<DIV Class="Normal">The Interrupt_Handler pragma is only allowed immediately 
within the <SPAN Class="swiss"><A HREF="RM-9-4.html#S0195">protected_definition</A></SPAN> 
where the corresponding subprogram is declared. The corresponding <SPAN Class="swiss"><A HREF="RM-9-4.html#S0193">protected_type_declaration</A></SPAN> 
or <SPAN Class="swiss"><A HREF="RM-9-4.html#S0194">single_protected_declaration</A></SPAN> 
shall be a library-level declaration.&nbsp;</DIV>

<H4 Class="centered">Dynamic Semantics</H4>
<DIV Class="paranum">9</DIV>
<DIV Class="Normal">If the pragma Interrupt_Handler appears in a <SPAN Class="swiss"><A HREF="RM-9-4.html#S0195">protected_definition</A></SPAN>, 
then the corresponding procedure can be attached dynamically, as a handler, 
to interrupts (see <A HREF="RM-C-3-2.html">C.3.2</A>). Such procedures 
are allowed to be attached to multiple interrupts.</DIV>
<DIV Class="paranum">10</DIV>
<DIV Class="Normal"><A NAME="I6684"></A><A NAME="I6685"></A>The <SPAN Class="swiss"><A HREF="RM-4-4.html#S0115">expression</A></SPAN> 
in the Attach_Handler pragma as evaluated at object creation time specifies 
an interrupt. As part of the initialization of that object, if the Attach_Handler 
pragma is specified, the <I>handler</I> procedure is attached to the 
specified interrupt. <A NAME="I6686"></A><A NAME="I6687"></A>A check 
is made that the corresponding interrupt is not reserved. <A NAME="I6688"></A>Program_Error 
is raised if the check fails, and the existing treatment for the interrupt 
is not affected.</DIV>
<DIV Class="paranum">11/2</DIV>
<DIV Class="Normal">&nbsp;<A NAME="I6689"></A><A NAME="I6690"></A><A NAME="I6691"></A>If 
the Ceiling_Locking policy (see <A HREF="RM-D-3.html">D.3</A>) is in 
effect, then upon the initialization of a protected object for which 
either an Attach_Handler or Interrupt_Handler pragma applies to one of 
its procedures, a check is made that the ceiling priority defined in 
the <SPAN Class="swiss"><A HREF="RM-9-4.html#S0195">protected_definition</A></SPAN> 
is in the range of System.Interrupt_Priority. <A NAME="I6692"></A>If 
the check fails, Program_Error is raised.</DIV>
<DIV Class="paranum">12/1</DIV>
<DIV Class="Normal">&nbsp;<A NAME="I6693"></A>When a protected object is finalized, 
for any of its procedures that are attached to interrupts, the handler 
is detached. If the handler was attached by a procedure in the Interrupts 
package or if no user handler was previously attached to the interrupt, 
the default treatment is restored. If an Attach_Handler pragma was used 
and the most recently attached handler for the same interrupt is the 
same as the one that was attached at the time the protected object was 
initialized, the previous handler is restored.&nbsp;</DIV>
<DIV Class="paranum">13</DIV>
<DIV Class="Normal">When a handler is attached to an interrupt, the interrupt 
is blocked (subject to the Implementation Permission in <A HREF="RM-C-3.html">C.3</A>) 
during the execution of every protected action on the protected object 
containing the handler.</DIV>

<H4 Class="centered">Erroneous Execution</H4>
<DIV Class="paranum">14</DIV>
<DIV Class="Normal"><A NAME="I6694"></A>If the Ceiling_Locking policy 
(see <A HREF="RM-D-3.html">D.3</A>) is in effect and an interrupt is 
delivered to a handler, and the interrupt hardware priority is higher 
than the ceiling priority of the corresponding protected object, the 
execution of the program is erroneous.</DIV>
<DIV Class="paranum">14.1/1</DIV>
<DIV Class="Normal">&nbsp;&nbsp;&nbsp;<A NAME="I6695"></A>If the handlers for a given 
interrupt attached via pragma Attach_Handler are not attached and detached 
in a stack-like (LIFO) order, program execution is erroneous. In particular, 
when a protected object is finalized, the execution is erroneous if any 
of the procedures of the protected object are attached to interrupts 
via pragma Attach_Handler and the most recently attached handler for 
the same interrupt is not the same as the one that was attached at the 
time the protected object was initialized.&nbsp;</DIV>

<H4 Class="centered">Metrics</H4>
<DIV Class="paranum">15</DIV>
<DIV Class="Normal" Style="margin-bottom: 0.4em">The following metric 
shall be documented by the implementation:&nbsp;</DIV>
<DIV Class="paranum">16/2</DIV>
<UL Class="Bulleted"><LI TYPE=DISC>The worst-case overhead for an interrupt 
handler that is a parameterless protected procedure, in clock cycles. 
This is the execution time not directly attributable to the handler procedure 
or the interrupted execution. It is estimated as C &ndash; (A+B), where 
A is how long it takes to complete a given sequence of instructions without 
any interrupt, B is how long it takes to complete a normal call to a 
given protected procedure, and C is how long it takes to complete the 
same sequence of instructions when it is interrupted by one execution 
of the same procedure called via an interrupt.&nbsp;</LI></UL>

<H4 Class="centered">Implementation Permissions</H4>
<DIV Class="paranum">17</DIV>
<DIV Class="Normal">When the pragmas Attach_Handler or Interrupt_Handler 
apply to a protected procedure, the implementation is allowed to impose 
implementation-defined restrictions on the corresponding <SPAN Class="swiss"><A HREF="RM-9-4.html#S0193">protected_type_declaration</A></SPAN> 
and <SPAN Class="swiss"><A HREF="RM-9-4.html#S0198">protected_body</A></SPAN>. 
</DIV>
<DIV Class="paranum">18</DIV>
<DIV Class="Normal">An implementation may use a different mechanism for 
invoking a protected procedure in response to a hardware interrupt than 
is used for a call to that protected procedure from a task.&nbsp;</DIV>
<DIV Class="paranum">19</DIV>
<DIV Class="Normal"><A NAME="I6696"></A>Notwithstanding what this subclause 
says elsewhere, the Attach_Handler and Interrupt_Handler pragmas are 
allowed to be used for other, implementation defined, forms of interrupt 
handlers.&nbsp;</DIV>

<H4 Class="centered">Implementation Advice</H4>
<DIV Class="paranum">20</DIV>
<DIV Class="Normal">Whenever possible, the implementation should allow 
interrupt handlers to be called directly by the hardware.&nbsp;</DIV>
<DIV Class="paranum">21</DIV>
<DIV Class="Normal">Whenever practical, the implementation should detect 
violations of any implementation-defined restrictions before run time. 
</DIV>
<DIV Class="NotesHeader">NOTES</DIV>
<DIV Class="paranum">22</DIV>
<DIV Class="Notes">4&nbsp;&nbsp;The Attach_Handler pragma can provide 
static attachment of handlers to interrupts if the implementation supports 
preelaboration of protected objects. (See <A HREF="RM-C-4.html">C.4</A>.)</DIV>
<DIV Class="paranum">23/2</DIV>
<DIV Class="Notes">5&nbsp;&nbsp;A protected object that has a (protected) 
procedure attached to an interrupt should have a ceiling priority at 
least as high as the highest processor priority at which that interrupt 
will ever be delivered.</DIV>
<DIV Class="paranum">24</DIV>
<DIV Class="Notes">6&nbsp;&nbsp;Protected procedures can also be attached 
dynamically to interrupts via operations declared in the predefined package 
Interrupts.</DIV>
<DIV Class="paranum">25</DIV>
<DIV Class="Notes">7&nbsp;&nbsp;An example of a possible implementation-defined 
restriction is disallowing the use of the standard storage pools within 
the body of a protected procedure that is an interrupt handler.</DIV>

<HR>
<DIV Style="margin-top: 0.0em; margin-bottom: 0.6em"><A HREF="RM-TOC.html"><IMG SRC="cont.gif" ALT="Contents" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-0-5.html"><IMG SRC="index.gif" ALT="Index" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-STDS.html"><IMG SRC="lib.gif" ALT="References" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-SRCH.html"><IMG SRC="find.gif" ALT="Search" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-C-3.html"><IMG SRC="prev.gif" ALT="Previous" BORDER=0></A>&nbsp;
&nbsp;<A HREF="RM-C-3-2.html"><IMG SRC="next.gif" ALT="Next" BORDER=0></A>&nbsp;
</DIV>
<DIV Style="margin-top:0.0em"><IMG SRC="AE_logo.gif" height=100 width=113 align=right ALT="Ada-Europe">
<SPAN Style="vertical-align: middle">Sponsored by <SPAN Style="font-size: 125%"><A HREF="http://www.ada-europe.org/"><B>Ada-Europe</B></A></SPAN></SPAN></DIV>
</BODY>
</HTML>
